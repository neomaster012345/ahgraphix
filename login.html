/**
 * JavaScript for AH Graphix Store - Authentication (v3 - Rewritten for Reliability)
 * Handles Email/Password, Google, and Anonymous sign-in,
 * and the redesigned signup page flow.
 */

import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
import { 
    getAuth, 
    onAuthStateChanged,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    updateProfile,
    signInWithPopup,
    GoogleAuthProvider,
    sendPasswordResetEmail,
    signInAnonymously,
    signOut
} from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

// This event listener ensures the entire HTML document is loaded and parsed
// before any of the code inside it runs.
document.addEventListener('DOMContentLoaded', () => {

    // --- Firebase Configuration ---
    const firebaseConfig = {
        apiKey: "AIzaSyD-ajuwQ3_O6M2Re6apA3iMFaVNjP5NjvM",
        authDomain: "ahgraphics-4c985.firebaseapp.com",
        projectId: "ahgraphics-4c985",
        storageBucket: "ahgraphics-4c985.appspot.com",
        messagingSenderId: "970036433684",
        appId: "1:970036433684:web:8b91f72345ec8248cd2801",
        measurementId: "G-LQQ2ST3C3K"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const googleProvider = new GoogleAuthProvider();

    // --- UI Element References ---
    const navAuthSection = document.getElementById('nav-auth-section');

    // --- Authentication State Observer (Updates the Nav Bar on all pages) ---
    onAuthStateChanged(auth, (user) => {
        console.log("Auth state changed. User:", user);
        if (navAuthSection) {
            if (user && !user.isAnonymous) {
                // User is signed in (and not anonymous)
                navAuthSection.innerHTML = `
                    <div class="flex items-center space-x-2 sm:space-x-4">
                        <span class="text-white hidden sm:block text-sm">Welcome, ${user.displayName || user.email.split('@')[0]}</span>
                        <button id="logout-btn" class="glow-button text-black px-3 py-2 sm:px-4 sm:py-2 rounded-full font-medium text-sm">Logout</button>
                    </div>
                `;
                document.getElementById('logout-btn').addEventListener('click', () => signOut(auth).then(() => window.location.href = 'index.html'));
            } else {
                // User is signed out or anonymous
                navAuthSection.innerHTML = `<a href="login.html" class="glow-button text-black px-4 py-2 rounded-full font-medium">Login</a>`;
                // If no user is logged in at all, sign them in anonymously for guest features
                if (!user) {
                    signInAnonymously(auth).catch(error => console.error("Anonymous sign-in failed:", error));
                }
            }
        }
    });

    // --- Page-Specific Logic ---
    // This structure ensures we only run code for the page the user is currently on.
    
    // LOGIC FOR LOGIN PAGE
    if (document.getElementById('login-form')) {
        console.log("Login page detected. Attaching listeners.");
        const loginForm = document.getElementById('login-form');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const loginError = document.getElementById('login-error');
        const forgotPasswordLink = document.getElementById('forgot-password-link');
        
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            signInWithEmailAndPassword(auth, email, password)
                .then(() => window.location.href = 'index.html')
                .catch(error => loginError.textContent = error.message);
        });

        googleLoginBtn.addEventListener('click', () => {
            signInWithPopup(auth, googleProvider)
                .then(() => window.location.href = 'index.html')
                .catch(error => loginError.textContent = error.message);
        });

        if (forgotPasswordLink) {
            const forgotPasswordModal = document.getElementById('forgot-password-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const resetPasswordForm = document.getElementById('reset-password-form');
            const resetMessage = document.getElementById('reset-message');

            forgotPasswordLink.addEventListener('click', (e) => {
                e.preventDefault();
                forgotPasswordModal.classList.replace('hidden', 'flex');
            });
            closeModalBtn.addEventListener('click', () => {
                forgotPasswordModal.classList.replace('flex', 'hidden');
                if(resetMessage) resetMessage.textContent = '';
            });
            resetPasswordForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('reset-email').value;
                resetMessage.textContent = '';
                resetMessage.classList.remove('text-red-500', 'text-green-500');
                sendPasswordResetEmail(auth, email)
                    .then(() => {
                        resetMessage.textContent = 'Success! Check your inbox for a password reset link.';
                        resetMessage.classList.add('text-green-500');
                    })
                    .catch(error => {
                        resetMessage.textContent = error.message;
                        resetMessage.classList.add('text-red-500');
                    });
            });
        }
    }

    // LOGIC FOR SIGNUP PAGE
    if (document.getElementById('signup-options')) {
        console.log("Signup page detected. Attaching listeners.");
        const signupOptions = document.getElementById('signup-options');
        const emailSignupBtn = document.getElementById('email-signup-btn');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const anonymousLoginBtn = document.getElementById('anonymous-login-btn');
        const signupForm = document.getElementById('signup-form');
        const signupError = document.getElementById('signup-error');

        emailSignupBtn.addEventListener('click', () => {
            signupOptions.classList.add('hidden');
            signupForm.classList.remove('hidden');
        });

        googleLoginBtn.addEventListener('click', () => {
            signInWithPopup(auth, googleProvider)
                .then(() => window.location.href = 'index.html')
                .catch(error => signupError.textContent = error.message);
        });

        anonymousLoginBtn.addEventListener('click', () => {
            signInAnonymously(auth)
                .then(() => window.location.href = 'index.html')
                .catch(error => signupError.textContent = error.message);
        });

        signupForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            createUserWithEmailAndPassword(auth, email, password)
                .then(userCredential => updateProfile(userCredential.user, { displayName: name }))
                .then(() => window.location.href = 'index.html')
                .catch(error => signupError.textContent = error.message);
        });
    }
});
